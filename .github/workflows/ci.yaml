# SPDX-License-Identifier: Apache-2.0
# Copyright 2025 Provability-Fabric Contributors

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache Node.js dependencies
        id: cache-node
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            runtime/ledger/node_modules
            marketplace/ui/node_modules
          key: node-${{ hashFiles('runtime/ledger/package-lock.json', 'marketplace/ui/package-lock.json') }}
          restore-keys: |
            node-

      - name: Cache Go dependencies
        id: cache-go
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: gomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            gomod-

      - name: Ensure cache hit (warning only on CI)
        if: github.event_name == 'push' && (steps.cache-node.outputs.cache-hit != 'true' || steps.cache-go.outputs.cache-hit != 'true')
        run: |
          if [ "${{ steps.cache-node.outputs.cache-hit }}" != "true" ]; then
            echo "::warning::Node cache miss â€” this may indicate missing lock files"
          fi
          if [ "${{ steps.cache-go.outputs.cache-hit }}" != "true" ]; then
            echo "::warning::Go cache miss â€” this may indicate missing go.sum files"
          fi

      - name: Install dependencies
        run: |
          # Install Python dependencies
          python -m pip install --upgrade pip
          pip install pytest kubernetes requests pyyaml psutil flake8-breakpoint

          # Install Go tools
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest

          # Install Rust tools
          cargo install cargo-fuzz

          # Install Node.js tools
          npm install -g @stoplight/spectral-cli

          # Install security tools
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.0

      - name: Install Node.js dependencies
        run: |
          # Install ledger dependencies
          cd runtime/ledger
          npm ci

          # Install marketplace UI dependencies
          cd ../../marketplace/ui
          npm ci

      - name: Run spectral lint
        run: |
          spectral lint **/spec.yaml --ruleset aispec-schema.json

      - name: Set up Lean
        run: |
          curl -L https://github.com/leanprover/lean4/releases/download/v4.7.0/lean-4.7.0-linux.tar.gz | tar -xz
          echo "$PWD/lean-4.7.0-linux/bin" >> $GITHUB_PATH

      - name: Cache Lean artifacts
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/lean
            core/lean-libs/.lake
            spec-templates/v1/proofs/.lake
          key: ${{ runner.os }}-lean-${{ hashFiles('**/lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Build Lean proofs (impacted only)
        run: |
          # Build core lean libs
          cd core/lean-libs
          lake build

          # Build spec templates  
          cd ../../spec-templates/v1/proofs
          lake build

          # Build impacted bundles if any
          if [ -n "${{ steps.impacted.outputs.impacted_targets }}" ]; then
            echo "Building impacted bundles: ${{ steps.impacted.outputs.impacted_targets }}"
            for target in ${{ steps.impacted.outputs.impacted_targets }}; do
              if [ -d "bundles/$target/proofs" ]; then
                echo "Building proofs for $target..."
                cd "bundles/$target/proofs"
                lake build
                cd ../../../..
              fi
            done
          else
            echo "No specific impacted targets identified, building all bundles"
            # Build all bundles
            for bundle in bundles/*/proofs; do
              if [ -d "$bundle" ]; then
                echo "Building $bundle..."
                cd "$bundle"
                lake build
                cd ../../../..
              fi
            done
          fi

      - name: Lean proof quality gate
        run: |
          echo "ðŸ” Running Lean proof quality gate..."
          python tools/lean_gate.py --root . --config tools/lean_gate_config.yaml

      - name: Lean build time budget check
        run: |
          echo "â±ï¸  Running Lean build time budget check..."
          chmod +x scripts/lean_time_budget.sh
          ./scripts/lean_time_budget.sh

      - name: Check for duplicate Lean definitions
        run: |
          echo "ðŸ” Checking for duplicate Lean definitions..."
          make lean-check-duplicates

      - name: Check for forbidden shadowing
        run: |
          echo "ðŸ” Checking for forbidden shadowing..."
          make lean-forbid-shadowing

      - name: Determine impacted targets
        id: impacted
        run: |
          echo "ðŸ” Determining impacted targets based on changes..."
          python tools/select_impacted.py --root . --output /tmp/impacted.json

          # Parse the JSON output to extract targets
          IMPACTED_TARGETS=$(python -c "
          import json
          with open('/tmp/impacted.json', 'r') as f:
              data = json.load(f)
              targets = data.get('impacted_targets', [])
              print(' '.join(targets))
          ")

          IMPACTED_TESTS=$(python -c "
          import json
          with open('/tmp/impacted.json', 'r') as f:
              data = json.load(f)
              tests = data.get('impacted_tests', [])
              print(' '.join(tests))
          ")

          ALLOWLIST_NEEDS_UPDATE=$(python -c "
          import json
          with open('/tmp/impacted.json', 'r') as f:
              data = json.load(f)
              print('true' if data.get('allowlist_needs_update', False) else 'false')
          ")

          echo "impacted_targets=$IMPACTED_TARGETS" >> $GITHUB_OUTPUT
          echo "impacted_tests=$IMPACTED_TESTS" >> $GITHUB_OUTPUT
          echo "allowlist_needs_update=$ALLOWLIST_NEEDS_UPDATE" >> $GITHUB_OUTPUT

          echo "Impacted targets: $IMPACTED_TARGETS"
          echo "Impacted tests: $IMPACTED_TESTS"
          echo "Allowlist needs update: $ALLOWLIST_NEEDS_UPDATE"

      - name: Generate allowlist from Lean proofs (if needed)
        if: steps.impacted.outputs.allowlist_needs_update == 'true'
        run: |
          echo "ðŸ”§ Generating allowlist from Lean proofs..."
          python tools/gen_allowlist_from_lean.py . /tmp/generated_allowlist.json

      - name: Compare generated allowlist with runtime (if needed)
        if: steps.impacted.outputs.allowlist_needs_update == 'true'
        run: |
          echo "ðŸ” Comparing generated allowlist with runtime..."
          if [ -f "runtime/sidecar-watcher/policy/allowlist.json" ]; then
            if diff /tmp/generated_allowlist.json runtime/sidecar-watcher/policy/allowlist.json > /dev/null; then
              echo "âœ… Generated allowlist matches runtime allowlist"
            else
              echo "âŒ Generated allowlist differs from runtime allowlist"
              echo "Generated:"
              cat /tmp/generated_allowlist.json
              echo "Runtime:"
              cat runtime/sidecar-watcher/policy/allowlist.json
              echo "Diff:"
              diff /tmp/generated_allowlist.json runtime/sidecar-watcher/policy/allowlist.json || true
              exit 1
            fi
          else
            echo "âš ï¸  No runtime allowlist found, using generated one"
            mkdir -p runtime/sidecar-watcher/policy/
            cp /tmp/generated_allowlist.json runtime/sidecar-watcher/policy/allowlist.json
          fi

      - name: Update runtime allowlist (if needed)
        if: steps.impacted.outputs.allowlist_needs_update == 'true'
        run: |
          echo "ðŸ”„ Updating runtime allowlist with generated version..."
          mkdir -p runtime/sidecar-watcher/policy/
          cp /tmp/generated_allowlist.json runtime/sidecar-watcher/policy/allowlist.json
          echo "âœ… Runtime allowlist updated"

      - name: Time-to-fail check
        run: |
          echo "âš¡ Checking time-to-fail for first failing lemma..."

          # Find all Lean files and check compilation time
          LEAN_FILES=$(find . -name "*.lean" -not -path "./.lake/*" -not -path "./vendor/*" | head -10)

          for file in $LEAN_FILES; do
            echo "Testing $file..."
            start_time=$(date +%s)
            
            # Try to compile the file with a 20-second timeout
            if timeout 20s lean --make "$file" >/dev/null 2>&1; then
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              echo "âœ… $file compiled in ${duration}s"
            else
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              if [ $duration -gt 20 ]; then
                echo "âŒ $file took ${duration}s (exceeded 20s TTF limit)"
                exit 1
              else
                echo "âš ï¸  $file failed to compile but within TTF limit"
              fi
            fi
          done

      - name: Run proofbench
        run: |
          echo "ðŸ§ª Running property-based testing with proofbench..."
          cd core/lean-libs
          lake build
          cd ../..
          lake exe proofbench

      - name: Test Go CLI
        run: |
          cd core/cli/pf
          # Run tests if they exist, otherwise just verify compilation
          if ls *_test.go >/dev/null 2>&1; then
            go test -v -coverprofile=coverage.out ./...
            
            # Check coverage threshold
            COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
            echo "Coverage: $COVERAGE%"
            # Use awk instead of bc for floating point comparison
            if awk "BEGIN {exit !($COVERAGE < 90)}"; then
              echo "âŒ Coverage below 90% threshold"
              exit 1
            fi
            echo "âœ… Coverage above 90% threshold"
          else
            echo "â„¹ï¸ No test files found, verifying compilation"
            go build -v ./...
          fi

      - name: Test Rust sidecar
        run: |
          cd runtime/sidecar-watcher
          # Run cargo test (will succeed even with no tests)
          cargo test
          # Run clippy for code quality
          cargo clippy -- -D warnings

      - name: Test Go admission controller
        run: |
          cd runtime/admission-controller
          # Run tests if they exist, otherwise just verify compilation
          if ls *_test.go >/dev/null 2>&1; then
            go test -v ./...
          else
            echo "â„¹ï¸ No test files found, verifying compilation"
            go build -v ./...
          fi

      - name: Test Node.js ledger
        run: |
          cd runtime/ledger
          # Check if test script exists and run it, otherwise build
          if npm run test 2>/dev/null || [ $? -eq 0 ]; then
            echo "âœ… Ledger tests completed"
          else
            echo "â„¹ï¸ Running build to verify TypeScript compilation"
            npm run build
          fi

      - name: Run red-team tests (impacted only)
        run: |
          # Install red-team test dependencies
          pip install -r tests/redteam/requirements.txt

          # Run impacted red-team tests or all if no specific tests identified
          if [ -n "${{ steps.impacted.outputs.impacted_tests }}" ]; then
            echo "Running impacted red-team tests: ${{ steps.impacted.outputs.impacted_tests }}"
            for test in ${{ steps.impacted.outputs.impacted_tests }}; do
              if [[ "$test" == *"redteam"* ]]; then
                echo "Running red-team test: $test"
                python "$test"
              fi
            done
          else
            echo "No specific impacted tests identified, running all red-team tests"
            # Run all red-team tests
            python tests/redteam/injection_runner.py
            python tests/redteam/abac_fuzz.py
          fi

      - name: Run performance tests (impacted only)
        run: |
          # Install k6 for performance testing
          curl -L https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz | tar -xz
          sudo cp k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

          # Run performance tests if impacted or if no specific tests identified
          if [ -n "${{ steps.impacted.outputs.impacted_tests }}" ]; then
            echo "Running impacted performance tests: ${{ steps.impacted.outputs.impacted_tests }}"
            for test in ${{ steps.impacted.outputs.impacted_tests }}; do
              if [[ "$test" == *"perf"* ]]; then
                echo "Running performance test: $test"
                k6 run "$test"
              fi
            done
          else
            echo "No specific impacted tests identified, running smoke performance test"
            # Run smoke performance test
            k6 run tests/perf/latency_k6.js --stage 60s:1000
          fi

      - name: Run integration tests (impacted only)
        run: |
          # Install integration test dependencies
          pip install -r tests/integration/requirements.txt

          # Run impacted integration tests or all if no specific tests identified
          if [ -n "${{ steps.impacted.outputs.impacted_tests }}" ]; then
            echo "Running impacted integration tests: ${{ steps.impacted.outputs.impacted_tests }}"
            timeout 20m pytest ${{ steps.impacted.outputs.impacted_tests }} -v
          else
            echo "No specific impacted tests identified, running all integration tests"
            timeout 20m pytest tests/integration/ -v
          fi

      - name: Sign spec bundles
        if: github.event_name == 'push'
        run: |
          # Install cosign
          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          chmod +x cosign-linux-amd64
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign

          # Sign bundles if they exist
          if [ -d "bundles" ]; then
            SIG_FILES=$(find bundles -name "spec.sig" 2>/dev/null || true)
            if [ -n "$SIG_FILES" ]; then
              echo "Signing specification bundles..."
              find bundles -name "spec.sig" -exec cosign sign-blob --bundle {}.bundle {} \;
            else
              echo "No spec.sig files found to sign"
            fi
          else
            echo "No bundles directory found, skipping signing"
          fi
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
